<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tạo hóa đơn từ ảnh bill</title>
<style>
  :root{--ink:#5f5f5f}
  html,body{margin:0;background:#f4f4f4;font-family:system-ui,Segoe UI,Arial,Helvetica,sans-serif}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:20px}
  .panel{display:flex;flex-direction:column;align-items:center;gap:12px}
  canvas{max-width:92vw;height:auto;box-shadow:0 10px 28px rgba(0,0,0,.12);background:#fff}
  .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  button{padding:10px 14px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  button:hover{border-color:#aaa}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .field{display:flex;align-items:center;gap:6px;font-size:14px}
  input[type="number"]{width:88px;padding:6px 8px}
  .hint{font-size:12px;opacity:.8}
  @media (prefers-color-scheme: dark){
    html,body{background:#0b0b0b;color:#ddd}
    canvas{background:#111}
    button{background:#0f0f0f;color:#ddd;border-color:#333}
    button:hover{border-color:#555}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <canvas id="c"></canvas>

      <!-- Vị trí và kiểu chữ có thể tinh chỉnh cho đúng chỗ ngày/giờ -->
      <div class="row">
        <div class="field">X: <input id="x" type="number" step="1"></div>
        <div class="field">Y: <input id="y" type="number" step="1"></div>
        <div class="field">Cỡ chữ: <input id="fs" type="number" step="1"></div>
        <div class="field">Độ mờ: <input id="alpha" type="number" min="0" max="1" step="0.05"></div>
      </div>

      <div class="btns">
        <button id="gen">Tạo hoá đơn (giờ VN)</button>
        <button id="download">Tải ảnh PNG</button>
      </div>
      <div class="hint">
        Ảnh gốc: <b>bill-base.png</b>. Dùng phím mũi tên để “nudge” vị trí (giữ Shift = +10px).
      </div>
    </div>
  </div>

<script>
/* ========= CẤU HÌNH MẶC ĐỊNH (chỉnh nếu cần) =========
 * Đây là toạ độ dòng "Thời gian 01-08-2025 18:11" trong ảnh bạn gửi.
 * Nếu ảnh gốc khác kích thước, bạn có thể tinh chỉnh trực tiếp trên UI.
 */
const DEFAULTS = {
  // Tọa độ x,y tính theo pixel của ảnh gốc
  x: 215,     // vị trí bắt đầu chuỗi thời gian
  y: 270,     // đường baseline chữ
  fontSize: 28,     // px
  alpha: 0.78       // độ mờ để giống giấy in nhiệt
};

// ĐƯỜNG DẪN ẢNH BILL GỐC (đặt file cạnh index.html)
const BILL_SRC = 'bill-base.png';

// ====== Helper: lấy thời gian VN, format dd-MM-yyyy HH:mm ======
const TZ = 'Asia/Ho_Chi_Minh';
const pad = n => String(n).padStart(2,'0');
function nowVN(){
  // convert “hiện tại” sang mốc VN
  const s = new Date().toLocaleString('en-US', { timeZone: TZ });
  return new Date(s);
}
function fmtVN(d){
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${dd}-${mm}-${yyyy} ${hh}:${mi}`;
}

// ====== Canvas logic ======
const cvs = document.getElementById('c');
const ctx = cvs.getContext('2d');

const ix = document.getElementById('x');
const iy = document.getElementById('y');
const ifs = document.getElementById('fs');
const ialpha = document.getElementById('alpha');

let img = new Image();
img.src = BILL_SRC;
img.onload = () => {
  cvs.width = img.naturalWidth;
  cvs.height = img.naturalHeight;

  // khởi tạo UI
  ix.value = DEFAULTS.x;
  iy.value = DEFAULTS.y;
  ifs.value = DEFAULTS.fontSize;
  ialpha.value = DEFAULTS.alpha;

  drawOnce("01-08-2025 18:11"); // vẽ ảnh gốc với text cũ để canh
};

function drawOnce(timeStr){
  // vẽ nền ảnh
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.drawImage(img, 0, 0, cvs.width, cvs.height);

  // thiết lập kiểu chữ na ná hóa đơn nhiệt mờ
  const x = Number(ix.value);
  const y = Number(iy.value);
  const fs = Number(ifs.value);
  const alpha = Number(ialpha.value);

  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.font = `600 ${fs}px Arial, Helvetica, sans-serif`;
  ctx.fillStyle = '#5f5f5f';

  // Tạo cảm giác mực nhiệt: vẽ 2 lần lệch subpixel + chút blur
  ctx.shadowColor = 'rgba(0,0,0,.20)';
  ctx.shadowBlur = 0.8;
  ctx.fillText(timeStr, x, y);
  ctx.shadowBlur = 0.3;
  ctx.fillText(timeStr, x+0.35, y+0.15);
  ctx.restore();
}

// tạo hóa đơn mới (thời gian thực)
function generate(){
  const t = nowVN();
  const s = fmtVN(t);
  drawOnce(s);
}

document.getElementById('gen').onclick = generate;
document.getElementById('download').onclick = () => {
  const a = document.createElement('a');
  a.href = cvs.toDataURL('image/png');
  a.download = 'bill-updated.png';
  a.click();
};

// Nudge bằng phím mũi tên
window.addEventListener('keydown', (e) => {
  const step = e.shiftKey ? 10 : 1;
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
    e.preventDefault();
    if (e.key==='ArrowLeft') ix.value = Number(ix.value) - step;
    if (e.key==='ArrowRight') ix.value = Number(ix.value) + step;
    if (e.key==='ArrowUp') iy.value = Number(iy.value) - step;
    if (e.key==='ArrowDown') iy.value = Number(iy.value) + step;
    generate();
  }
});

// Vẽ lại khi thay đổi tham số
[ix, iy, ifs, ialpha].forEach(inp => {
  inp.addEventListener('input', () => {
    generate();
  });
});
</script>
</body>
</html>
