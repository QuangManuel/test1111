<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tạo hóa đơn từ ảnh bill</title>
<style>
  html,body{margin:0;background:#f4f4f4;font-family:system-ui,Segoe UI,Arial}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:20px}
  canvas{max-width:92vw;height:auto;box-shadow:0 10px 28px rgba(0,0,0,.12);background:#fff}
  .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  button,input,select{font:inherit}
  button{padding:10px 14px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  button:hover{border-color:#aaa}
  details{margin-top:10px;background:#fff;border:1px solid #e6e6e6;border-radius:8px;padding:8px 10px;max-width:92vw}
  .grid{display:grid;grid-template-columns:repeat(6,minmax(0,140px));gap:10px}
  .field{display:flex;flex-direction:column;font-size:14px}
  .field input{padding:8px;border:1px solid #ddd;border-radius:6px}
  .muted{opacity:.75;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div>
    <canvas id="c"></canvas>

    <div class="btns">
      <button id="gen">Tạo hoá đơn</button>
      <button id="download">Tải ảnh PNG</button>
    </div>

    <details>
      <summary>Chỉnh vị trí (lưu tự động)</summary>
      <div class="grid">
        <div class="field">
          <label>Chọn lớp</label>
          <select id="layer">
            <option value="time">Thời gian</option>
            <option value="code">Mã hoá đơn</option>
          </select>
        </div>
        <div class="field"><label>X</label><input id="x" type="number" step="1"></div>
        <div class="field"><label>Y</label><input id="y" type="number" step="1"></div>
        <div class="field"><label>Cỡ chữ</label><input id="fs" type="number" step="1"></div>
        <div class="field"><label>Độ mờ (0–1)</label><input id="alpha" type="number" min="0" max="1" step="0.05"></div>
        <div class="field"><label>Mẫu mã HĐ</label>
          <input id="pattern" placeholder="093 02 {YYYY}{MM}{DD} {SEQ4}">
          <div class="muted">Token: {YYYY}{MM}{DD}{HH}{mm}{SEQ2|SEQ3|SEQ4}</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Mẹo: Dùng phím mũi tên để nudge vị trí (Shift = 10px).</div>
    </details>
  </div>
</div>

<script>
/* ----------------- CẤU HÌNH & MẶC ĐỊNH ----------------- */
const BILL_SRC = 'bill-base.png';  // ảnh gốc đặt cạnh index.html
const DEFAULTS = {
  // Toạ độ & style đã ước lượng cho ảnh bạn gửi. Bạn có thể tinh chỉnh trong UI.
  time:  { x: 215, y: 270, fontSize: 28, alpha: 0.78 },
  code:  { x: 215, y: 210, fontSize: 28, alpha: 0.78 }, // nằm trên dòng "Thời gian ..."
  pattern: '093 02 {YYYY}{MM}{DD} {SEQ4}'
};
const TZ = 'Asia/Ho_Chi_Minh';

/* ----------------- TIỆN ÍCH THỜI GIAN & SEQ ----------------- */
const pad = (n,w=2)=>String(n).padStart(w,'0');
function nowVN(){
  const s = new Date().toLocaleString('en-US', { timeZone: TZ });
  return new Date(s);
}
function fmtTimeVN(d){ // dd-MM-yyyy HH:mm
  return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function nextSeq(keyBase, digits){
  const key = `seq-${keyBase}-${digits}`;
  const cur = Number(localStorage.getItem(key) || 0) + 1;
  localStorage.setItem(key, String(cur));
  return pad(cur, digits);
}
function buildCode(pattern, d){
  const yyyy = d.getFullYear(), MM = pad(d.getMonth()+1), DD = pad(d.getDate());
  const HH = pad(d.getHours()), mm = pad(d.getMinutes());
  // seq theo ngày để mỗi ngày reset
  const base = `${yyyy}${MM}${DD}`;
  const seq4 = nextSeq(base, 4);
  const seq3 = seq4.slice(-3);
  const seq2 = seq4.slice(-2);
  return pattern
    .replaceAll('{YYYY}', yyyy)
    .replaceAll('{MM}', MM)
    .replaceAll('{DD}', DD)
    .replaceAll('{HH}', HH)
    .replaceAll('{mm}', mm)
    .replaceAll('{SEQ4}', seq4)
    .replaceAll('{SEQ3}', seq3)
    .replaceAll('{SEQ2}', seq2);
}

/* ----------------- LƯU / TẢI CẤU HÌNH ----------------- */
const cfg = JSON.parse(localStorage.getItem('bill-cfg') || 'null') || DEFAULTS;
function saveCfg(){ localStorage.setItem('bill-cfg', JSON.stringify(cfg)); }

/* ----------------- CANVAS DRAW ----------------- */
const cvs = document.getElementById('c');
const ctx = cvs.getContext('2d',{alpha:false});
const img = new Image(); img.src = BILL_SRC;
img.onload = () => { cvs.width = img.naturalWidth; cvs.height = img.naturalHeight; draw(); };

function draw(textTime = "01-08-2025 18:11", textCode = cfg.pattern){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.drawImage(img,0,0,cvs.width,cvs.height);

  // vẽ mã hoá đơn
  drawText(textCode, cfg.code);
  // vẽ thời gian
  drawText(textTime, cfg.time);
}
function drawText(str, style){
  ctx.save();
  ctx.globalAlpha = style.alpha;
  ctx.font = `600 ${style.fontSize}px Arial, Helvetica, sans-serif`;
  ctx.fillStyle = '#5f5f5f';
  // hiệu ứng “mực nhiệt”: vẽ 2 lần lệch subpixel + shadow nhẹ
  ctx.shadowColor = 'rgba(0,0,0,.20)';
  ctx.shadowBlur = 0.8;
  ctx.fillText(str, style.x, style.y);
  ctx.shadowBlur = 0.3;
  ctx.fillText(str, style.x+0.35, style.y+0.15);
  ctx.restore();
}

/* ----------------- UI & HÀNH ĐỘNG ----------------- */
const $ = id => document.getElementById(id);
const layerSel = $('layer'), xI=$('x'), yI=$('y'), fsI=$('fs'), aI=$('alpha'), patI=$('pattern');

function syncPanel(){
  const L = cfg[layerSel.value];
  xI.value = L.x; yI.value = L.y; fsI.value = L.fontSize; aI.value = L.alpha;
  patI.value = cfg.pattern;
}
layerSel.onchange = syncPanel;
[xI,yI,fsI,aI].forEach(inp=>{
  inp.oninput = ()=>{
    const L = cfg[layerSel.value];
    L.x = Number(xI.value);
    L.y = Number(yI.value);
    L.fontSize = Number(fsI.value);
    L.alpha = Number(aI.value);
    saveCfg(); draw();
  };
});
patI.oninput = ()=>{ cfg.pattern = patI.value; saveCfg(); draw(); };
syncPanel();

// Nudge nhanh bằng phím
window.addEventListener('keydown',e=>{
  const step = e.shiftKey?10:1;
  const L = cfg[layerSel.value];
  if(e.key==='ArrowLeft'){L.x-=step}
  if(e.key==='ArrowRight'){L.x+=step}
  if(e.key==='ArrowUp'){L.y-=step}
  if(e.key==='ArrowDown'){L.y+=step}
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){ saveCfg(); draw(); e.preventDefault(); }
});

// Tạo hoá đơn
$('gen').onclick = ()=>{
  const t = nowVN();
  const timeStr = fmtTimeVN(t);
  const codeStr = buildCode(cfg.pattern, t);
  draw(timeStr, codeStr);
};

// Tải ảnh
$('download').onclick = ()=>{
  const a = document.createElement('a');
  a.href = cvs.toDataURL('image/png');
  a.download = 'bill-updated.png';
  a.click();
};

// Vẽ ban đầu (ảnh gốc với text mẫu để canh)
draw();
</script>
</body>
</html>
